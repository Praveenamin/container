<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #1e40af; }
        .auth-container { display: flex; justify-content: center; align-items: center; height: 80vh; }
        .login-form { width: 300px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: #f9fafb; }
        .login-form h2 { text-align: center; color: #1e40af; }
        .login-form input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-form button { width: 100%; padding: 10px; background-color: #1e40af; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .login-form button:hover { background-color: #1d4ed8; }
        .dashboard-content { display: none; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; border-radius: 8px 8px 0 0; background-color: #eee; }
        .tab-button.active { background-color: #fff; border-top: 2px solid #1e40af; border-left: 2px solid #1e40af; border-right: 2px solid #1e40af; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #1e40af; color: white; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .action-buttons button { padding: 5px 10px; margin-right: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .edit-btn { background-color: #f97316; color: white; }
        .delete-btn { background-color: #ef4444; color: white; }
        .add-btn { background-color: #22c55e; color: white; padding: 8px 15px; border-radius: 5px; }
        .form-container { display: none; margin-top: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background: #f9fafb; }
        .form-container.active { display: block; }
        .form-container input, .form-container select { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .form-buttons { display: flex; justify-content: flex-end; }
        .form-buttons button { margin-left: 10px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .user-info { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .user-info h2 { color: #1e40af; }
    </style>
</head>
<body>

<div class="auth-container" id="auth-container">
    <div class="login-form">
        <h2>Employee Portal Login</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    </div>
</div>

<div class="container dashboard-content" id="dashboard-container">
    <div class="header">
        <h1 id="portal-title">Employee Portal</h1>
        <button id="logout-btn">Logout</button>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" style="display: none;">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('users-tab', this)">User Management</button>
            <button class="tab-button" onclick="showTab('assets-tab', this)">IT Asset List</button>
        </div>

        <div id="users-tab" class="tab-content">
            <button class="add-btn" onclick="showUserForm()">Add User</button>
            <div id="user-form-container" class="form-container">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <input type="text" id="user-first-name" placeholder="First Name" required>
                    <input type="text" id="user-last-name" placeholder="Last Name" required>
                    <input type="email" id="user-email" placeholder="Email" required>
                    <input type="password" id="user-password" placeholder="Password" required>
                    <input type="text" id="user-emp-id" placeholder="Employee ID" required>
                    <input type="text" id="user-designation" placeholder="Designation" required>
                    <label>
                        <input type="checkbox" id="user-is-admin"> Is Admin
                    </label>
                    <div class="form-buttons">
                        <button type="button" onclick="hideForm('user-form-container')">Cancel</button>
                        <button type="submit">Save User</button>
                    </div>
                </form>
            </div>
            <div class="table-container">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Emp ID</th>
                            <th>Designation</th>
                            <th>Admin</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="assets-tab" class="tab-content" style="display:none;">
            <button class="add-btn" onclick="showAssetForm()">Add IT Asset</button>
            <div id="asset-form-container" class="form-container">
                <form id="asset-form">
                    <input type="hidden" id="asset-id">
                    <select id="asset-user-id">
                        <!-- User options will be populated here -->
                    </select>
                    <input type="text" id="asset-type" placeholder="Type (Laptop/Desktop)" required>
                    <input type="text" id="asset-model" placeholder="Model" required>
                    <input type="text" id="asset-serial-number" placeholder="Serial Number" required>
                    <input type="text" id="asset-monitor" placeholder="Monitor">
                    <input type="text" id="asset-keyboard" placeholder="Keyboard">
                    <input type="text" id="asset-mouse" placeholder="Mouse">
                    <input type="text" id="asset-wifi-lan-ip" placeholder="IP Address">
                    <textarea id="asset-comments" placeholder="Comments"></textarea>
                    <div class="form-buttons">
                        <button type="button" onclick="hideForm('asset-form-container')">Cancel</button>
                        <button type="submit">Save Asset</button>
                    </div>
                </form>
            </div>
            <div class="table-container">
                <table id="assets-table">
                    <thead>
                        <tr>
                            <th>Assigned User</th>
                            <th>Type</th>
                            <th>Model</th>
                            <th>Serial Number</th>
                            <th>Monitor</th>
                            <th>Keyboard</th>
                            <th>Mouse</th>
                            <th>IP Address</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" style="display: none;">
        <div class="user-info">
            <h2>Your Profile</h2>
            <div id="user-profile-info"></div>
        </div>
        <h3>Your IT Assets</h3>
        <div class="table-container">
            <table id="user-assets-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Model</th>
                        <th>Serial Number</th>
                        <th>Monitor</th>
                        <th>Keyboard</th>
                        <th>Mouse</th>
                        <th>IP Address</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Custom Modal for Alerts and Confirmations -->
<div id="custom-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center;">
    <div style="background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center;">
        <p id="modal-message" style="margin-bottom: 20px;"></p>
        <div id="modal-buttons">
            <button id="modal-ok" style="background-color: #1e40af; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">OK</button>
            <button id="modal-cancel" style="background-color: #ccc; color: #333; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; display: none;">Cancel</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Corrected API URL to point to the new backend server
    const API_URL = `http://${window.location.hostname}:3337/api`;
    const authContainer = document.getElementById('auth-container');
    const dashboardContainer = document.getElementById('dashboard-container');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const adminDashboard = document.getElementById('admin-dashboard');
    const userDashboard = document.getElementById('user-dashboard');
    const portalTitle = document.getElementById('portal-title');

    let currentAuthToken = null;
    let currentUser = null;
    
    // --- Custom Modal Functions ---
    const customModal = document.getElementById('custom-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalOkBtn = document.getElementById('modal-ok');
    const modalCancelBtn = document.getElementById('modal-cancel');

    function showAlert(message) {
        modalMessage.textContent = message;
        modalCancelBtn.style.display = 'none';
        modalOkBtn.style.display = 'inline-block';
        modalOkBtn.onclick = () => {
            customModal.style.display = 'none';
        };
        customModal.style.display = 'flex';
    }

    function showConfirm(message, callback) {
        modalMessage.textContent = message;
        modalCancelBtn.style.display = 'inline-block';
        modalOkBtn.style.display = 'inline-block';
        modalOkBtn.onclick = () => {
            customModal.style.display = 'none';
            if (callback) callback(true);
        };
        modalCancelBtn.onclick = () => {
            customModal.style.display = 'none';
            if (callback) callback(false);
        };
        customModal.style.display = 'flex';
    }
    
    // Helper function to escape HTML special characters for safe `onclick` attributes
    function escapeHtml(str) {
        return str ? str.replace(/'/g, '&apos;').replace(/"/g, '&quot;') : '';
    }

    // Helper function to fetch data
    async function fetchData(endpoint, method = 'GET', data = null) {
        const headers = { 'Content-Type': 'application/json' };
        if (currentAuthToken) {
            headers['Authorization'] = `Bearer ${currentAuthToken}`;
        }

        const options = { method, headers };
        if (data) {
            options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_URL}${endpoint}`, options);
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || response.statusText);
        }
        return await response.json();
    }

    // Function to handle login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetchData('/login', 'POST', { email, password });
            currentAuthToken = response.token;
            currentUser = response.user;

            if (currentUser.is_admin) {
                renderAdminDashboard();
            } else {
                renderUserDashboard();
            }
        } catch (error) {
            showAlert('Login failed: ' + error.message);
        }
    });

    logoutBtn.addEventListener('click', () => {
        currentAuthToken = null;
        currentUser = null;
        authContainer.style.display = 'flex';
        dashboardContainer.style.display = 'none';
        adminDashboard.style.display = 'none';
        userDashboard.style.display = 'none';
        document.getElementById('login-form').reset();
    });

    // Admin functions
    async function renderAdminDashboard() {
        authContainer.style.display = 'none';
        dashboardContainer.style.display = 'block';
        adminDashboard.style.display = 'block';
        userDashboard.style.display = 'none';
        portalTitle.textContent = 'Admin Portal';
        await fetchUsers();
        await fetchAssets();
    }

    async function fetchUsers() {
        const usersTableBody = document.querySelector('#users-table tbody');
        usersTableBody.innerHTML = '<tr><td colspan="7">Loading users...</td></tr>';
        try {
            const users = await fetchData('/users');
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const row = usersTableBody.insertRow();
                row.innerHTML = `
                    <td>${escapeHtml(user.first_name)}</td>
                    <td>${escapeHtml(user.last_name)}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${escapeHtml(user.emp_id)}</td>
                    <td>${escapeHtml(user.designation)}</td>
                    <td>${user.is_admin ? 'Yes' : 'No'}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editUser(${user.id}, '${escapeHtml(user.first_name)}', '${escapeHtml(user.last_name)}', '${escapeHtml(user.email)}', '${escapeHtml(user.emp_id)}', '${escapeHtml(user.designation)}', '${user.is_admin}')">Edit</button>
                        <button class="delete-btn" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                `;
            });
            populateUserSelect(users);
        } catch (error) {
            usersTableBody.innerHTML = `<tr><td colspan="7" style="color: red;">Error: ${error.message}</td></tr>`;
        }
    }

    async function fetchAssets() {
        const assetsTableBody = document.querySelector('#assets-table tbody');
        assetsTableBody.innerHTML = '<tr><td colspan="10">Loading assets...</td></tr>';
        try {
            const assets = await fetchData('/assets');
            assetsTableBody.innerHTML = '';
            assets.forEach(asset => {
                const row = assetsTableBody.insertRow();
                row.innerHTML = `
                    <td>${asset.first_name ? `${escapeHtml(asset.first_name)} ${escapeHtml(asset.last_name)} (${escapeHtml(asset.emp_id)})` : 'Unassigned'}</td>
                    <td>${escapeHtml(asset.type)}</td>
                    <td>${escapeHtml(asset.model)}</td>
                    <td>${escapeHtml(asset.serial_number)}</td>
                    <td>${escapeHtml(asset.monitor || '-')}</td>
                    <td>${escapeHtml(asset.keyboard || '-')}</td>
                    <td>${escapeHtml(asset.mouse || '-')}</td>
                    <td>${escapeHtml(asset.wifi_lan_ip || '-')}</td>
                    <td>${escapeHtml(asset.comments || '-')}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editAsset(${asset.id}, ${asset.user_id}, '${escapeHtml(asset.type)}', '${escapeHtml(asset.model)}', '${escapeHtml(asset.serial_number)}', '${escapeHtml(asset.monitor)}', '${escapeHtml(asset.keyboard)}', '${escapeHtml(asset.mouse)}', '${escapeHtml(asset.wifi_lan_ip)}', '${escapeHtml(asset.comments)}')">Edit</button>
                        <button class="delete-btn" onclick="deleteAsset(${asset.id})">Delete</button>
                    </td>
                `;
            });
        } catch (error) {
            assetsTableBody.innerHTML = `<tr><td colspan="10" style="color: red;">Error: ${error.message}</td></tr>`;
        }
    }

    function populateUserSelect(users) {
        const select = document.getElementById('asset-user-id');
        select.innerHTML = '<option value="">Unassigned</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.first_name} ${user.last_name} (${user.emp_id})`;
            select.appendChild(option);
        });
    }

    function showTab(tabId, button) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).style.display = 'block';
        button.classList.add('active');
    }

    function showForm(formId, isEditing = false) {
        document.querySelectorAll('.form-container').forEach(form => form.classList.remove('active'));
        document.getElementById(formId).classList.add('active');
        const submitBtn = document.querySelector(`#${formId} button[type="submit"]`);
        submitBtn.textContent = isEditing ? 'Update' : 'Save';
        
        // Toggle the password field's required state and visibility
        const passwordInput = document.getElementById('user-password');
        if (isEditing) {
            passwordInput.required = false;
            passwordInput.placeholder = 'New Password (leave blank to keep current)';
        } else {
            passwordInput.required = true;
            passwordInput.placeholder = 'Password';
        }
    }

    function hideForm(formId) {
        document.getElementById(formId).classList.remove('active');
        document.querySelector(`#${formId} form`).reset();
    }

    function showUserForm(user = null) {
        const form = document.getElementById('user-form');
        form.reset();
        document.getElementById('user-id').value = '';
        if (user) {
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-first-name').value = user.first_name;
            document.getElementById('user-last-name').value = user.last_name;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-emp-id').value = user.emp_id;
            document.getElementById('user-designation').value = user.designation;
            document.getElementById('user-is-admin').checked = user.is_admin;
            showForm('user-form-container', true);
        } else {
            showForm('user-form-container', false);
        }
    }
    
    // Correctly handle the boolean value from the onclick attribute
    function editUser(id, first_name, last_name, email, emp_id, designation, isAdmin) {
        showUserForm({ 
            id, 
            first_name, 
            last_name, 
            email, 
            emp_id, 
            designation, 
            is_admin: isAdmin === 'true' 
        });
    }

    function showAssetForm(asset = null) {
        const form = document.getElementById('asset-form');
        form.reset();
        document.getElementById('asset-id').value = '';
        if (asset) {
            document.getElementById('asset-id').value = asset.id;
            document.getElementById('asset-user-id').value = asset.user_id;
            document.getElementById('asset-type').value = asset.type;
            document.getElementById('asset-model').value = asset.model;
            document.getElementById('asset-serial-number').value = asset.serial_number;
            document.getElementById('asset-monitor').value = asset.monitor;
            document.getElementById('asset-keyboard').value = asset.keyboard;
            document.getElementById('asset-mouse').value = asset.mouse;
            document.getElementById('asset-wifi-lan-ip').value = asset.wifi_lan_ip;
            document.getElementById('asset-comments').value = asset.comments;
            showForm('asset-form-container', true);
        } else {
            showForm('asset-form-container', false);
        }
    }

    function editAsset(id, user_id, type, model, serial_number, monitor, keyboard, mouse, wifi_lan_ip, comments) {
        showAssetForm({ id, user_id, type, model, serial_number, monitor, keyboard, mouse, wifi_lan_ip, comments });
    }

    document.getElementById('user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('user-id').value;
        const userData = {
            first_name: document.getElementById('user-first-name').value,
            last_name: document.getElementById('user-last-name').value,
            email: document.getElementById('user-email').value,
            emp_id: document.getElementById('user-emp-id').value,
            designation: document.getElementById('user-designation').value,
            is_admin: document.getElementById('user-is-admin').checked,
        };
        const password = document.getElementById('user-password').value;
        if (password) {
            userData.password = password;
        }

        try {
            if (id) {
                await fetchData(`/users/${id}`, 'PUT', userData);
            } else {
                if (!userData.password) {
                    showAlert('Password is required for new users.');
                    return;
                }
                await fetchData('/users', 'POST', userData);
            }
            hideForm('user-form-container');
            await fetchUsers();
        } catch (error) {
            showAlert('Error saving user: ' + error.message);
        }
    });

    async function deleteUser(id) {
        showConfirm('Are you sure you want to delete this user?', async (confirmed) => {
            if (confirmed) {
                try {
                    await fetchData(`/users/${id}`, 'DELETE');
                    await fetchUsers();
                } catch (error) {
                    showAlert('Error deleting user: ' + error.message);
                }
            }
        });
    }

    document.getElementById('asset-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('asset-id').value;
        const assetData = {
            user_id: document.getElementById('asset-user-id').value || null,
            type: document.getElementById('asset-type').value,
            model: document.getElementById('asset-model').value,
            serial_number: document.getElementById('asset-serial-number').value,
            monitor: document.getElementById('asset-monitor').value,
            keyboard: document.getElementById('asset-keyboard').value,
            mouse: document.getElementById('asset-mouse').value,
            wifi_lan_ip: document.getElementById('asset-wifi-lan-ip').value,
            comments: document.getElementById('asset-comments').value,
        };
        try {
            if (id) {
                await fetchData(`/assets/${id}`, 'PUT', assetData);
            } else {
                await fetchData('/assets', 'POST', assetData);
            }
            hideForm('asset-form-container');
            await fetchAssets();
        } catch (error) {
            showAlert('Error saving asset: ' + error.message);
        }
    });

    async function deleteAsset(id) {
        showConfirm('Are you sure you want to delete this asset?', async (confirmed) => {
            if (confirmed) {
                try {
                    await fetchData(`/assets/${id}`, 'DELETE');
                    await fetchAssets();
                } catch (error) {
                    showAlert('Error deleting asset: ' + error.message);
                }
            }
        });
    }

    // User functions
    async function renderUserDashboard() {
        authContainer.style.display = 'none';
        dashboardContainer.style.display = 'block';
        adminDashboard.style.display = 'none';
        userDashboard.style.display = 'block';
        portalTitle.textContent = 'My IT Portal';
        await fetchUserProfile();
        await fetchUserAssets();
    }

    async function fetchUserProfile() {
        const profileInfo = document.getElementById('user-profile-info');
        profileInfo.innerHTML = 'Loading profile...';
        try {
            const user = await fetchData('/profile');
            profileInfo.innerHTML = `
                <p><strong>Name:</strong> ${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}</p>
                <p><strong>Email:</strong> ${escapeHtml(user.email)}</p>
                <p><strong>Employee ID:</strong> ${escapeHtml(user.emp_id)}</p>
                <p><strong>Designation:</strong> ${escapeHtml(user.designation)}</p>
            `;
        } catch (error) {
            profileInfo.innerHTML = `<p style="color: red;">Error loading profile: ${error.message}</p>`;
        }
    }

    async function fetchUserAssets() {
        const userAssetsTableBody = document.querySelector('#user-assets-table tbody');
        userAssetsTableBody.innerHTML = '<tr><td colspan="8">Loading assets...</td></tr>';
        try {
            const assets = await fetchData('/my_assets');
            userAssetsTableBody.innerHTML = '';
            if (assets.length === 0) {
                userAssetsTableBody.innerHTML = '<tr><td colspan="8">No assets assigned to you.</td></tr>';
            } else {
                assets.forEach(asset => {
                    const row = userAssetsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${escapeHtml(asset.type)}</td>
                        <td>${escapeHtml(asset.model)}</td>
                        <td>${escapeHtml(asset.serial_number)}</td>
                        <td>${escapeHtml(asset.monitor || '-')}</td>
                        <td>${escapeHtml(asset.keyboard || '-')}</td>
                        <td>${escapeHtml(asset.mouse || '-')}</td>
                        <td>${escapeHtml(asset.wifi_lan_ip || '-')}</td>
                        <td>${escapeHtml(asset.comments || '-')}</td>
                    `;
                });
            }
        } catch (error) {
            userAssetsTableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Error loading assets: ${error.message}</td></tr>`;
        }
    }
});
</script>
</body>
</html>

